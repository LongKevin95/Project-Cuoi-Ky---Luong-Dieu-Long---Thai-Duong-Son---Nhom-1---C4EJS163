<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Profile</title>
    <link rel="stylesheet" href="../css/style.css" />
    <link rel="stylesheet" href="../css/pages/user-profile.css" />
  </head>

  <body>
    <main class="profile-page">
      <div class="o-container">
        <div class="profile-card">
          <div class="profile-head">
            <div class="profile-left">
              <img id="avatarPreview" class="profile-avatar" alt="avatar" />
              <div>
                <h2 id="displayName" class="profile-name">User</h2>
                <p id="displayEmail" class="profile-sub">email</p>
              </div>
            </div>

            <div class="profile-actions">
              <label
                class="pbtn pbtn-primary"
                style="display: inline-flex; align-items: center; gap: 8px"
              >
                <a class="btn btn-ghost" href="../index.html"
                  >üè† V·ªÅ trang ch·ªß</a
                >
                Upload New Photo
                <input
                  id="avatarFile"
                  type="file"
                  accept="image/*"
                  style="display: none"
                />
              </label>
              <button class="pbtn pbtn-ghost" id="btnSave">Save</button>
            </div>
          </div>

          <div class="profile-grid">
            <div class="field">
              <label>First Name</label>
              <input id="firstName" placeholder="eg. Son" />
            </div>
            <div class="field">
              <label>Last Name</label>
              <input id="lastName" placeholder="eg. Deptrai" />
            </div>

            <div class="field full">
              <label>User Name</label>
              <input id="username" placeholder="eg. sondep***" />
            </div>

            <div class="field">
              <label>Email</label>
              <input id="email" disabled />
            </div>

            <div class="field">
              <label>Phone Number</label>
              <input id="phone" placeholder="eg. 09xxxxxxxx" />
            </div>
          </div>

          <p class="note">Th√¥ng tin ƒë∆∞·ª£c l∆∞u v√†o localStorage (demo).</p>
        </div>
      </div>
    </main>

    <script>
      const USERS_KEY = "users";
      const CURRENT_USER_KEY = "user";

      function getUsers() {
        return JSON.parse(localStorage.getItem(USERS_KEY)) || [];
      }
      function saveUsers(users) {
        localStorage.setItem(USERS_KEY, JSON.stringify(users));
      }
      function getCurrentUser() {
        return JSON.parse(localStorage.getItem(CURRENT_USER_KEY));
      }
      function saveCurrentUser(u) {
        localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(u));
      }

      function ensureProfile(u) {
        if (!u.profile) u.profile = {};
        u.profile.firstName ??= "";
        u.profile.lastName ??= "";
        u.profile.username ??= u.name || "";
        u.profile.phone ??= "";
        u.profile.avatar ??= "https://i.pravatar.cc/120?img=32";
        return u;
      }

      const u = getCurrentUser();
      if (!u) {
        alert("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p!");
        window.location.href = "login.html";
      }

      let current = ensureProfile(u);

      const avatarPreview = document.getElementById("avatarPreview");
      const displayName = document.getElementById("displayName");
      const displayEmail = document.getElementById("displayEmail");

      function render() {
        avatarPreview.src = current.profile.avatar;
        displayName.textContent =
          (current.profile.firstName || current.name || "User") +
          " " +
          (current.profile.lastName || "");
        displayEmail.textContent = current.email || "";

        document.getElementById("firstName").value =
          current.profile.firstName || "";
        document.getElementById("lastName").value =
          current.profile.lastName || "";
        document.getElementById("username").value =
          current.profile.username || "";
        document.getElementById("phone").value = current.profile.phone || "";
        document.getElementById("email").value = current.email || "";
      }

      // upload avatar -> base64
      document
        .getElementById("avatarFile")
        .addEventListener("change", function () {
          const file = this.files?.[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = () => {
            current.profile.avatar = reader.result;
            avatarPreview.src = current.profile.avatar;
          };
          reader.readAsDataURL(file);
        });

      document.getElementById("btnSave").addEventListener("click", () => {
        current.profile.firstName = document
          .getElementById("firstName")
          .value.trim();
        current.profile.lastName = document
          .getElementById("lastName")
          .value.trim();
        current.profile.username = document
          .getElementById("username")
          .value.trim();
        current.profile.phone = document.getElementById("phone").value.trim();

        const fullName =
          `${current.profile.firstName} ${current.profile.lastName}`.trim();
        current.name = fullName || current.profile.username || current.name;
        current.username = current.profile.username || current.username;

        // c·∫≠p nh·∫≠t v√†o users[]
        const users = getUsers();
        const idx = users.findIndex((x) => x.id === current.id);
        if (idx !== -1) users[idx] = current;
        saveUsers(users);

        // c·∫≠p nh·∫≠t current user
        saveCurrentUser(current);

        render();
        alert("C·∫≠p nh·∫≠t th√¥ng tin th√†nh c√¥ng ‚úÖ");
      });

      render();
    </script>
  </body>
</html>
